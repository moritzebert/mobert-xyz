<!DOCTYPE html>





<html lang="en-US" data-theme="">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="theme-name" content="Anubis2">

<title>Backups with restic from TrueNAS Scale to Hetzner Storage Box - mobert.xyz</title>

<meta name="description" content="Until recently, I didn’t have a proper backup strategy for my NAS. I simply replicated the data to an external hard drive, which was also located in my apartment – essentially the only copy of my data.
Now that I’m using my NAS in a production environment and primarily store important data there, I need a reliable method to back up this data securely to the cloud and restore it in case of a failure.">





<link rel="icon" type="image/x-icon" href="https://mobert.xyz/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="https://mobert.xyz/apple-touch-icon.png">





<style>
  body {
    visibility: hidden;
    opacity: 0;
  }
</style>

<noscript>
  <style>
    body {
      visibility: visible;
      opacity: 1;
    }
  </style>
</noscript>




    





    
    
        
    
    

    
        <link rel="stylesheet" href="/css/style.min.d5cd988d4911fc4173942ce51861fa9205910c3ae21b28a7dc8913b338157fe6.css" integrity="sha256-1c2YjUkR/EFzlCzlGGH6kgWRDDriGyin3IkTszgVf&#43;Y=">
    





    





    
    
        
    
    

    
        <link rel="stylesheet" href="/css/style.min.c4c04b3ef88e3d619ad4c7ee5e03048422bc55c4fefdc1f07657c1133670aa22.css" integrity="sha256-xMBLPviOPWGa1MfuXgMEhCK8VcT&#43;/cHwdlfBEzZwqiI=">
    





    





    
    
        
    
    

    
        <link rel="stylesheet" href="/css/style.min.21c5d8fe0a79d623b0adc1ce4bd4f6dd2c05cd939c9aaaa966ba7186b1464f4d.css" integrity="sha256-IcXY/gp51iOwrcHOS9T23SwFzZOcmqqpZrpxhrFGT00=">
    





    





    
    
        
    
    

    
        <link rel="stylesheet" href="/css/style.min.508bd813cbc27a3978d0cde578e221f3e6c83958ae6be174eaf93004b8ce8785.css" integrity="sha256-UIvYE8vCejl40M3leOIh8&#43;bIOViua&#43;F06vkwBLjOh4U=">
    

















    

    





    
    
        
    
    

    
        <script src="/js/script.min.08f04d96386c73c9bf4d160333f8f448c05a6e01c06770542ee0e013954ce930.js" type="text/javascript" charset="utf-8" integrity="sha256-CPBNljhsc8m/TRYDM/j0SMBabgHAZ3BULuDgE5VM6TA="></script>
    










    
</head>
<body>
    <a class="skip-main" href="#main">Skip to main content</a>
    <div class="container">
        <header class="common-header">
            
                <div class="header-top">
    <div class="header-top-left">
        <h1 class="site-title noselect">
    <a href="/">mobert.xyz</a>
</h1>

        


    
        <div class="theme-switcher">
            <span class="inline-svg">

    


    
    
    
    
    

    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-sun-high"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14.828 14.828a4 4 0 1 0 -5.656 -5.656a4 4 0 0 0 5.656 5.656z" /><path d="M6.343 17.657l-1.414 1.414" /><path d="M6.343 6.343l-1.414 -1.414" /><path d="M17.657 6.343l1.414 -1.414" /><path d="M17.657 17.657l1.414 1.414" /><path d="M4 12h-2" /><path d="M12 4v-2" /><path d="M20 12h2" /><path d="M12 20v2" /></svg>


</span>

        </div>
    

    <script>
        const STORAGE_KEY = 'user-color-scheme'
        const defaultTheme = "light"

        let currentTheme
        let switchButton
        let autoDefinedScheme = window.matchMedia('(prefers-color-scheme: dark)')

        function switchTheme(e) {
            currentTheme = (currentTheme === 'dark') ? 'light' : 'dark';
            if (localStorage) localStorage.setItem(STORAGE_KEY, currentTheme);
            document.documentElement.setAttribute('data-theme', currentTheme);
            changeGiscusTheme(currentTheme);
            document.body.dispatchEvent(new CustomEvent(currentTheme + "-theme-set"));
        }

        const autoChangeScheme = e => {
            currentTheme = e.matches ? 'dark' : 'light'
            document.documentElement.setAttribute('data-theme', currentTheme);
            changeGiscusTheme(currentTheme);
            document.body.dispatchEvent(new CustomEvent(currentTheme + "-theme-set"));
        }

        document.addEventListener('DOMContentLoaded', function () {
            switchButton = document.querySelector('.theme-switcher')
            currentTheme = detectCurrentScheme()

            if (currentTheme === 'auto') {
                autoChangeScheme(autoDefinedScheme);
                autoDefinedScheme.addListener(autoChangeScheme);
            } else {
                document.documentElement.setAttribute('data-theme', currentTheme)
            }

            if (switchButton) {
                switchButton.addEventListener('click', switchTheme, false)
            }

            showContent();
        })

        function detectCurrentScheme() {
            if (localStorage !== null && localStorage.getItem(STORAGE_KEY)) {
                return localStorage.getItem(STORAGE_KEY)
            }
            if (defaultTheme) {
                return defaultTheme
            }
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function showContent() {
            document.body.style.visibility = 'visible';
            document.body.style.opacity = 1;
        }

        function changeGiscusTheme (theme) {
            function sendMessage(message) {
              const iframe = document.querySelector('iframe.giscus-frame');
              if (!iframe) return;
              iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
            }

            sendMessage({
              setConfig: {
                theme: theme
              }
            });
        }
    </script>


        <ul class="social-icons noselect">







    <li>
            <a href="/index.xml" title="RSS" rel="me">
            <span class="inline-svg">

    


    
    
    
    
    

    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-rss"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 19m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" /><path d="M4 4a16 16 0 0 1 16 16" /><path d="M4 11a9 9 0 0 1 9 9" /></svg>


</span>

            </a>
        </li>
    

</ul>

    </div>
    <div class="header-top-right">

    </div>
</div>


    <nav class="noselect">
        
        
        <a class="" href="https://mobert.xyz/" title="">Home</a>
        
        <a class="" href="https://mobert.xyz/posts/" title="">Posts</a>
        
        <a class="" href="https://mobert.xyz/tags/" title="">Tags</a>
        
    </nav>






            
        </header>
        <main id="main" tabindex="-1">
            
    <article class="post h-entry">
        <div class="post-header">
            <header>
                
                
                
                <h1 class="p-name post-title ">Backups with restic from TrueNAS Scale to Hetzner Storage Box</h1>
                

            </header>
            



<div class="post-info noselect">
    
        <div class="post-date dt-published">
            <time datetime="2025-03-02">2025-03-02</time>
            
        </div>
    

    <a class="post-hidden-url u-url" href="/posts/backups-with-restic-on-truenas/">/posts/backups-with-restic-on-truenas/</a>
    <a href="https://mobert.xyz/" class="p-name p-author post-hidden-author h-card" rel="me">map[name:Moritz]</a>


    <div class="post-taxonomies">
        
        
            <ul class="post-tags">
                
                    
                    <li><a href="/tags/backup">#backup</a></li>
                
                    
                    <li><a href="/tags/storage">#storage</a></li>
                
            </ul>
        
        
    </div>
</div>

        </div>
        





  
  
  
  <details class="toc noselect">
    <summary>Table of Contents</summary>
    <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#why-restic">Why restic?</a></li>
    <li><a href="#installing-restic-on-truenas-scale">Installing restic on TrueNAS Scale</a>
      <ul>
        <li><a href="#installation-commands">Installation commands</a></li>
      </ul>
    </li>
    <li><a href="#setting-up-access-to-the-hetzner-storage-box">Setting up access to the Hetzner Storage Box</a></li>
    <li><a href="#creating-a-repository">Creating a repository</a></li>
    <li><a href="#automating-backups">Automating backups</a>
      <ul>
        <li><a href="#script-explanation">Script explanation</a></li>
        <li><a href="#cron-job-for-automatic-backups">Cron job for automatic backups</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
  </details>
  



<script>
  var toc = document.querySelector(".toc");
  if (toc) {
    toc.addEventListener("click", function () {
      if (event.target.tagName !== "A") {
        event.preventDefault();
        if (this.open) {
          this.open = false;
          this.classList.remove("expanded");
        } else {
          this.open = true;
          this.classList.add("expanded");
        }
      }
    });
  }
</script>

        <div class="content e-content">
            <p>Until recently, I didn’t have a proper backup strategy for my NAS. I simply replicated the data to an external hard drive, which was also located in my apartment – essentially the only copy of my data.</p>
<p>Now that I’m using my NAS in a production environment and primarily store important data there, I need a reliable method to back up this data securely to the cloud and restore it in case of a failure.</p>
<p>For this, I chose <strong><a href="https://restic.net" target="_blank" rel="noopener noreferrer">restic</a></strong>.</p>
<hr>
<h2 id="why-restic" >
<div>
    <a href="#why-restic">
        #
    </a>
    Why restic?
</div>
</h2>
<ul>
<li><strong>Security:</strong> Backups are encrypted by default</li>
<li><strong>Efficiency:</strong> Deduplication saves storage space and bandwidth</li>
<li><strong>Simplicity:</strong> Easy to use via the command line</li>
<li><strong>Automation:</strong> Simple integration into scripts or cron jobs</li>
<li><strong>Flexibility:</strong> Supports multiple transfer protocols (SFTP, REST, Rsync)</li>
</ul>
<h2 id="installing-restic-on-truenas-scale" >
<div>
    <a href="#installing-restic-on-truenas-scale">
        #
    </a>
    Installing restic on TrueNAS Scale
</div>
</h2>
<p>Since TrueNAS Scale is a closed system, restic cannot be installed via a package manager. Instead, I download the latest version directly from GitHub.</p>
<h3 id="installation-commands" >
<div>
    <a href="#installation-commands">
        ##
    </a>
    Installation commands
</div>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#99d1db">cd</span> /root/
</span></span><span style="display:flex;"><span>wget https://github.com/restic/restic/releases/download/v0.17.3/restic_0.17.3_linux_amd64.bz2
</span></span><span style="display:flex;"><span>7z x ./restic_0.17.3_linux_amd64.bz2; rm ./restic_0.17.3_linux_amd64.bz2
</span></span><span style="display:flex;"><span>mv ./restic_0.17.3_linux_amd64 ./restic
</span></span><span style="display:flex;"><span>chmod +x ./restic
</span></span><span style="display:flex;"><span>/root/restic self-update
</span></span></code></pre></div><p>Now, restic can be executed with the command <code>/root/restic</code>.</p>
<h2 id="setting-up-access-to-the-hetzner-storage-box" >
<div>
    <a href="#setting-up-access-to-the-hetzner-storage-box">
        #
    </a>
    Setting up access to the Hetzner Storage Box
</div>
</h2>
<p>For restic to store backups via SFTP on the Hetzner Storage Box, SSH access must be configured.</p>
<ol>
<li>In <strong>Hetzner Robot</strong>, select the Storage Box and enable SSH support.</li>
<li>Generate a key pair using <code>ssh-keygen</code>.</li>
<li>Transfer the public key to the Storage Box:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat ~/.ssh/id_rsa.pub | ssh -p23 u000000@u000000.your-storagebox.de install-ssh-key
</span></span></code></pre></div><p><em>(Replace <code>u000000</code> with your actual Storage Box username.)</em></p>
<h2 id="creating-a-repository" >
<div>
    <a href="#creating-a-repository">
        #
    </a>
    Creating a repository
</div>
</h2>
<p>Use the following command to create a new backup repository on the Storage Box:</p>
<div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/root/restic -r sftp:u000000@u000000.your-storagebox.de:/restic/reponame init
</span></span></code></pre></div><p>You now have an empty backup repository where backups can be stored.</p>
<h2 id="automating-backups" >
<div>
    <a href="#automating-backups">
        #
    </a>
    Automating backups
</div>
</h2>
<p>To run backups regularly, I created a shell script at <code>/root/scripts/restic.sh</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#737994;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"># restic backup</span>
</span></span><span style="display:flex;"><span>/root/restic -r sftp:u000000@u000000.your-storagebox.de:/restic/share --password-file <span style="color:#a6d189">&#34;/root/scripts/restic-pass&#34;</span> --tag auto backup /mnt/storage/share;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"># restic forget (remove old snapshots based on retention policy)</span>
</span></span><span style="display:flex;"><span>/root/restic -r sftp:u000000@u000000.your-storagebox.de:/restic/share --password-file <span style="color:#a6d189">&#34;/root/scripts/restic-pass&#34;</span> forget --prune --keep-tag keep --keep-daily <span style="color:#ef9f76">7</span> --keep-weekly <span style="color:#ef9f76">4</span> --keep-monthly <span style="color:#ef9f76">6</span> --keep-yearly 5;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"># clean up cache</span>
</span></span><span style="display:flex;"><span>/root/restic cache --cleanup;
</span></span></code></pre></div><h3 id="script-explanation" >
<div>
    <a href="#script-explanation">
        ##
    </a>
    Script explanation
</div>
</h3>
<ol>
<li><strong>Run backup</strong>: The data in <code>/mnt/storage/share</code> is backed up to the repository on the Storage Box.</li>
<li><strong>Manage old snapshots</strong>:
<ul>
<li><strong>Daily snapshots</strong>: Keep 7 days</li>
<li><strong>Weekly snapshots</strong>: Keep 4 weeks</li>
<li><strong>Monthly snapshots</strong>: Keep 6 months</li>
<li><strong>Yearly snapshots</strong>: Keep 5 years</li>
</ul>
</li>
<li><strong>Clean up cache</strong> to free up disk space.</li>
</ol>
<p>The file <code>/root/scripts/restic-pass</code> contains the repository password and is required for the script to run automatically.</p>
<h3 id="cron-job-for-automatic-backups" >
<div>
    <a href="#cron-job-for-automatic-backups">
        ##
    </a>
    Cron job for automatic backups
</div>
</h3>
<p>To ensure the backup script runs regularly, a cron job is set up.
This is done through the <strong>TrueNAS Web GUI</strong>:</p>
<ol>
<li>Navigate to <strong>System &gt; Advanced Settings &gt; Cron Jobs</strong></li>
<li>Add a new cron job with the following command:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/bin/bash /root/scripts/restic.sh
</span></span></code></pre></div><ol start="3">
<li>Schedule: <strong>Run daily at 04:00 AM</strong></li>
<li>Enable email notifications to be informed of any errors.</li>
</ol>
<p><img src="img/restic-cronjob.png" alt="restic Cron Job"></p>

        </div>
    </article>

    
    
    

    








    
    
    
    

        </main>
        
            <footer class="common-footer noselect">
    
    

    <div class="common-footer-bottom">
        

        <div style="display: flex; align-items: center; gap:8px">
            
            ©  Moritz,  2025
            
        </div>
        <div style="display:flex; align-items: center; gap:4px">
            
            

            
        </div>
        
            <div>
                Powered by <a target="_blank" rel="noopener noreferrer" href="https://gohugo.io/">Hugo</a>, theme <a target="_blank" rel="noopener noreferrer" href="https://github.com/hugo-theme-anubis2/hugo-theme-anubis2">Anubis2</a>.<br>
            </div>
        
    </div>
</footer>

        
    </div>
</body>
</html>
